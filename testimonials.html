<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Customer Testimonials — ET Naturals</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0b0c; --card:#151618; --text:#f6f7f9; --muted:#9aa3ae; --stroke:#2a2d31; --accent:#52a5ff; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text); }
    a { color:var(--accent); text-decoration:none; }
    header { max-width:920px; margin:28px auto 0; padding:0 20px; display:flex; align-items:center; justify-content:space-between; }
    header .brand { font-weight:800; letter-spacing:.3px; }
    .wrap { max-width:920px; margin:18px auto 40px; padding:0 20px; display:grid; gap:20px; }
    .card { background:var(--card); border-radius:14px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.35); border:1px solid var(--stroke); }
    h1 { margin:0 0 6px; }
    .muted { color:var(--muted); }
    .grid { display:grid; gap:16px; }
    @media(min-width:820px){ .grid.cols-2{ grid-template-columns:1fr 1fr; } }

    /* Testimonial cards */
    .t { display:grid; gap:8px; }
    .who { display:flex; gap:10px; align-items:center; }
    .avatar { width:40px; height:40px; border-radius:999px; background:#0f1012; border:1px solid var(--stroke); display:grid; place-items:center; font-weight:800; }
    .stars { letter-spacing:2px; }
    .stars .on { color:#FFD140; }
    .quote { color:#dfe3e7; }
    .meta { font-size:12px; color:#muted; }
    .t img.review-photo { width:100%; max-height:220px; object-fit:cover; border-radius:12px; border:1px solid var(--stroke); margin-bottom:8px; }

    /* Modal form */
    .open-form { appearance:none; border:1px solid var(--stroke); background:#0f1012; color:#f6f7f9; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:9999; }
    .modal[aria-hidden="false"] { display:flex; }
    .modal-dialog { width:min(900px, 96vw); background:var(--card); border:1px solid var(--stroke); border-radius:14px; box-shadow:0 12px 40px rgba(0,0,0,.5); overflow:hidden; }
    .modal-head { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid var(--stroke); }
    .modal-head h3 { margin:0; font-size:16px; }
    .modal-close { appearance:none; background:transparent; color:#f6f7f9; border:1px solid var(--stroke); border-radius:8px; padding:6px 10px; cursor:pointer; }
    .modal-body { padding:0; }

    /* Modal form fields */
    .form { padding:14px; display:grid; gap:10px; }
    .form input, .form select, .form textarea {
      width:100%; background:#0f1012; border:1px solid var(--stroke);
      color:#f6f7f9; border-radius:10px; padding:10px;
    }
    .form button { cursor:pointer; }

    /* Footer nav */
    .footer-nav{ max-width:920px; margin:10px auto 40px; padding:10px 20px; color:var(--muted); text-align:center; }
    .footer-nav .links{ display:flex; flex-wrap:wrap; gap:14px; justify-content:center; margin-bottom:6px; }
    .footer-nav a{ color:#f6f7f9; opacity:.9; }
    .footer-nav a:hover{ opacity:1; text-decoration:underline; }
    .footer-nav .legal{ font-size:12px; opacity:.75; }
  </style>
</head>
<body>
  <header>
    <div class="brand"><a href="index.html">ET NATURALS</a></div>
    <nav class="muted">
      <a href="index.html#shop">Shop</a> •
      <a href="about.html">About</a> •
      <a href="order.html">Checkout</a>
    </nav>
  </header>

  <main class="wrap">
    <!-- Intro -->
    <section class="card">
      <h1>Customer Testimonials</h1>
      <p class="muted">Real experiences from our community. New submissions appear instantly below.</p>
    </section>

    <!-- Approved (curated + live from sheet) -->
    <section class="grid cols-2" id="approved">
      <!-- Example seed cards (keep or remove) -->
      <article class="card t">
        <div class="who">
          <div class="avatar">M</div>
          <div>
            <div><b>Maria H.</b> <span class="meta">Austin, TX</span></div>
            <div class="stars" aria-label="5 out of 5 stars"><span class="on">★★★★★</span></div>
          </div>
        </div>
        <p class="quote">“Menopause hit and my scalp felt fussy. This kept my routine simple and my hair looks fuller.”</p>
        <div class="meta">Used: Root Renewal</div>
      </article>
      <article class="card t">
        <div class="who">
          <div class="avatar">D</div>
          <div>
            <div><b>Denise P.</b> <span class="meta">Chicago, IL</span></div>
            <div class="stars" aria-label="5 out of 5 stars"><span class="on">★★★★★</span></div>
          </div>
        </div>
        <p class="quote">“Overnight routine, less breakage on my brush, and I like the rosemary/clove aroma.”</p>
        <div class="meta">Used: Root Renewal</div>
      </article>
    </section>

    <!-- Submit a testimonial (opens modal) -->
    <section class="card" id="submit">
      <h2 style="margin:0 0 6px">Share your experience</h2>
      <p class="muted">Your words help others.</p>

      <button class="open-form" id="openFormBtn" type="button">Add your testimonial</button>
      <p class="hint" style="margin-top:8px">Prefer email? Write us at <a href="mailto:etnaturals@outlook.com">etnaturals@outlook.com</a>.</p>
    </section>

    <section class="card">
      <p class="muted">Cosmetic product. Individual experiences vary; no medical or therapeutic claims are made.</p>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal" id="formModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="formModalTitle">
    <div class="modal-dialog">
      <div class="modal-head">
        <h3 id="formModalTitle">Share your experience</h3>
        <button class="modal-close" id="closeFormBtn" type="button" aria-label="Close">Close</button>
      </div>
      <div class="modal-body">
        <!-- Inline form -->
        <form id="reviewForm" class="form">
          <div class="row" style="gap:10px">
            <div style="flex:1;min-width:200px">
              <label for="reviewName">Name</label>
              <input id="reviewName" type="text" placeholder="Your name" required>
            </div>
            <div style="flex:1;min-width:200px">
              <label for="reviewLoc">City, State (optional)</label>
              <input id="reviewLoc" type="text" placeholder="e.g., Omaha, NE">
            </div>
          </div>

          <label for="reviewRating">Rating</label>
          <select id="reviewRating" required>
            <option value="" selected disabled>Select…</option>
            <option>5</option><option>4</option><option>3</option><option>2</option><option>1</option>
          </select>

          <label for="reviewText">Your experience</label>
          <textarea id="reviewText" rows="4" placeholder="What did you think?" required></textarea>

          <label for="reviewPhoto">Photo (optional)</label>
          <input id="reviewPhoto" type="file" accept="image/jpeg,image/png,image/webp">
          <img id="photoPreview" alt="" style="display:none;max-width:160px;border-radius:12px;margin-top:8px;border:1px solid var(--stroke)">

          <div class="actions" style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
            <button type="button" class="modal-close" id="closeFormBtn2">Cancel</button>
            <button class="open-form" type="submit">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer nav -->
  <nav class="footer-nav">
    <div class="links">
      <a href="index.html#shop">Shop</a>
      <a href="about.html">About</a>
      <a href="testimonials.html">Testimonials</a>
      <a href="index.html#ingredients">Ingredients</a>
      <a href="faq.html">FAQ</a>
      <a href="order.html">Checkout</a>
    </div>
    <div class="legal">© <span id="year"></span> ET Naturals</div>
  </nav>

  <script>
  // ====== CONFIGURE THIS ======
  const CSV_URL_APPROVED = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLDBav_545GPz3w7ihMPN8YWqmZ0XGODHuI4A9OkrojMAbZlwEcOnOBQMMwF1ZI13eIzAc5ywrN1Jc/pub?gid=1688658905&single=true&output=csv';
  // ============================

  // Max file size in MB (keep small since we'll send base64)
  // Max file size in MB (keep small since we'll send base64)
const MAX_IMAGE_MB = 2;
const ALLOWED_TYPES = ["image/jpeg","image/png","image/webp"];

function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    if (!file) return resolve(null);
    if (!ALLOWED_TYPES.includes(file.type)) {
      return reject(new Error("Please upload JPG, PNG, or WEBP (HEIC isn’t supported)."));
    }
    const sizeMb = file.size / (1024 * 1024);
    if (sizeMb > MAX_IMAGE_MB) {
      return reject(new Error(`Image must be ≤ ${MAX_IMAGE_MB} MB.`));
    }
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = () => reject(new Error("Could not read image file."));
    r.readAsDataURL(file);
  });
}


  // Read file as a data URL (e.g., "data:image/jpeg;base64,...")
  function fileToDataURL(file) {
    return new Promise((resolve, reject) => {
      if (!file) return resolve(null);
      if (!/^image\//.test(file.type)) return reject(new Error("Please upload an image file."));
      const sizeMb = file.size / (1024 * 1024);
      if (sizeMb > MAX_IMAGE_MB) return reject(new Error(`Image must be ≤ ${MAX_IMAGE_MB} MB.`));
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = () => reject(new Error("Could not read image file."));
      r.readAsDataURL(file);
    });
  }

  document.getElementById('year').textContent = new Date().getFullYear();

  // Modal open/close
  (function(){
    const modal = document.getElementById('formModal');
    const openBtn = document.getElementById('openFormBtn');
    const closeBtn = document.getElementById('closeFormBtn');
    function open(){ modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
    function close(){ modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
    openBtn.addEventListener('click', open);
    closeBtn.addEventListener('click', close);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
  })();

  // Load approved (public)
  loadCSV(CSV_URL_APPROVED, mountApproved);

  // --- CSV helpers (with cache-buster) ---
  function parseCSV(text){
    const rows = [];
    let row = [], cell = '', inQuotes = false;
    for (let i = 0; i < text.length; i++){
      const ch = text[i], next = text[i+1];
      if (inQuotes){
        if (ch === '"' && next === '"'){ cell += '"'; i++; }
        else if (ch === '"'){ inQuotes = false; }
        else { cell += ch; }
      } else {
        if (ch === '"'){ inQuotes = true; }
        else if (ch === ','){ row.push(cell); cell=''; }
        else if (ch === '\n'){ row.push(cell); rows.push(row); row=[]; cell=''; }
        else if (ch === '\r'){ /* skip */ }
        else { cell += ch; }
      }
    }
    if (cell.length || row.length) { row.push(cell); rows.push(row); }
    return rows;
  }

  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]
    ));
  }

  function starHTML(n){
    n = Number(n)||0; n = Math.max(1, Math.min(5, n));
    return `<span class="on">${'★★★★★'.slice(0,n)}</span>${'★★★★★'.slice(n).replace(/./g,'☆')}`;
  }

  // tolerate header variations
  function findCol(head, candidates){
    const norm = s => s.toLowerCase().replace(/\s+/g,' ').trim();
    const H = head.map(norm);
    for (const cand of candidates){
      const i = H.indexOf(norm(cand));
      if (i !== -1) return i;
    }
    // partial match fallback
    for (let i=0;i<H.length;i++){
      if (candidates.some(c => H[i].includes(norm(c)))) return i;
    }
    return -1;
  }

  // cache-buster
  function withCacheBuster(url){
    const sep = url.includes('?') ? '&' : '?';
    return `${url}${sep}_cb=${Date.now()}`;
  }

  function loadCSV(url, cb){
    if(!url) return;
    fetch(withCacheBuster(url), { cache:'no-store' })
      .then(r => r.text())
      .then(t => cb(parseCSV(t)))
      .catch(() => {/* silent */});
  }

  function mapRows(rows){
    if (!rows || !rows.length) return [];
    const head = rows[0].map(h => h.trim());
    const idx = {
      name:   findCol(head, ['Full Name','Name']),
      loc:    findCol(head, ['City, State','City / State','City','Location']),
      rating: findCol(head, ['Rating','Stars','Star Rating']),
      msg:    findCol(head, ['Your Testimonial','Testimonial','Your Experience','Review','Comment','Message','Feedback']),
      img:    findCol(head, ['Image URL','image_url','Photo','Image'])
    };
    return rows.slice(1).map(r => ({
      name:   (idx.name>=0? r[idx.name] : '').trim(),
      loc:    (idx.loc >=0? r[idx.loc]  : '').trim(),
      rating: (idx.rating>=0? r[idx.rating] : '5').trim(),
      msg:    (idx.msg >=0? r[idx.msg]  : '').trim(),
      img:    (idx.img >=0? r[idx.img]  : '').trim()
    })).filter(x => x.name && x.msg);
  }

  function cardHTML(t){
    const initial = (t.name||'?')[0]?.toUpperCase() || '?';
    const photo = t.img ? `<img class="review-photo" src="${escapeHTML(t.img)}" alt="Customer photo" loading="lazy">` : '';
    return `
      <article class="card t">
        ${photo}
        <div class="who">
          <div class="avatar">${escapeHTML(initial)}</div>
          <div>
            <div><b>${escapeHTML(t.name)}</b> ${t.loc?`<span class="meta">${escapeHTML(t.loc)}</span>`:''}</div>
            <div class="stars" aria-label="${t.rating} out of 5 stars">${starHTML(t.rating)}</div>
          </div>
        </div>
        <p class="quote">“${escapeHTML(t.msg)}”</p>
        <div class="meta">Used: Root Renewal</div>
      </article>
    `;
  }

  function mountApproved(rows){
    const list = mapRows(rows);
    const mount = document.getElementById('approved');
    mount.insertAdjacentHTML('beforeend',
      list.length ? list.map(cardHTML).join('') :
      `<div class="muted">No approved testimonials yet.</div>`
    );
  }

  // === Submit handler + preview (Apps Script + Drive, writes straight to Approved) ===
  document.addEventListener('DOMContentLoaded', () => {
    const form  = document.getElementById('reviewForm');
    const modal = document.getElementById('formModal');
    if (!form) return;

    // Live image preview
    const photoInput = document.getElementById('reviewPhoto');
    const prev = document.getElementById('photoPreview');
    if (photoInput && prev) {
      photoInput.addEventListener('change', () => {
        const f = photoInput.files?.[0];
        if (f) { prev.src = URL.createObjectURL(f); prev.style.display = 'block'; }
        else { prev.removeAttribute('src'); prev.style.display = 'none'; }
      });
    }

    // Secondary cancel button
    const close2 = document.getElementById('closeFormBtn2');
    if (close2) close2.addEventListener('click', () => {
      modal.setAttribute('aria-hidden','true'); document.body.style.overflow='';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name   = document.getElementById('reviewName')?.value?.trim() || '';
      const loc    = document.getElementById('reviewLoc')?.value?.trim() || '';
      const rating = document.getElementById('reviewRating')?.value || '';
      const text   = document.getElementById('reviewText')?.value?.trim() || '';
      const file   = document.getElementById('reviewPhoto')?.files?.[0] || null;

      try {
        // convert optional photo to data URL (base64)
        const image_data_url = await fileToDataURL(file);

        // send to your Apps Script Web App
        const payload = { name, loc, rating, text, image_data_url };
        const res = await fetch("https://script.google.com/macros/s/AKfycbwGNcxdOPkGdWBfGblTUOOxczaerAPGxnk-sCb46Jks08zou_QIwOPBj1QqcDAcJq-W/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) throw new Error("Could not submit review.");
        alert("Thanks! Your review was submitted.");
        form.reset();
        if (prev) { prev.removeAttribute('src'); prev.style.display = 'none'; }
        modal.setAttribute('aria-hidden','true'); document.body.style.overflow='';
        // Reload approved list after a short delay (to allow Sheet write to publish)
        setTimeout(() => { document.getElementById('approved').innerHTML = ''; loadCSV(CSV_URL_APPROVED, mountApproved); }, 1000);
      } catch (err) {
        alert(err.message || "Something went wrong.");
      }
    });
  });
  </script>
</body>
</html>